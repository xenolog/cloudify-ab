tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/4.1.1/types.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/2.2.0/plugin.yaml
#  - https://raw.githubusercontent.com/cloudify-incubator/cloudify-utilities-plugin/1.2.5/plugin.yaml

inputs:
  ubuntu_user:
    default: { get_secret: ubuntu_xenial_user }
  image:
    default: { get_secret: ubuntu_xenial_image }
  flavor:
    default: { get_secret: ubuntu_xenial_flavor }
  mgmt_network_name:
    default: { get_secret: mgmt_network_name }
  keystone_username:
    default: { get_secret: keystone_username }
  keystone_password:
    default: { get_secret: keystone_password }
  keystone_tenant_name:
    default: { get_secret: keystone_tenant_name }
  keystone_url:
    default: { get_secret: keystone_url }
  region:
    default: { get_secret: region }
  ssh_pub_key:
    default: { get_secret: ssh_pub_key }
  ssh_pvt_key:
    default: { get_secret: ssh_pvt_key }
  ssh_keyset_name:
    default: { get_secret: ssh_keyset_name }

dsl_definitions:
  openstack_config: &openstack_config
    username: { get_input: keystone_username }
    password: { get_input: keystone_password }
    tenant_name: { get_input: keystone_tenant_name }
    auth_url: { get_input: keystone_url }
    region: { get_input: region }

node_types:
  instance:
    derived_from: cloudify.openstack.nodes.Server
    properties:
      agent_config:
        default:
          user:
            get_input: ubuntu_user
          install_method: remote
          port: 22
          key:
            get_input: ssh_pvt_key
      cloudify_agent:
        default:
          agent_key_path:
            get_input: ssh_pvt_key
          user:
            get_input: ubuntu_user
      management_network_name:
        default:
          get_input: mgmt_network_name
      server:
        default:
          image:
            get_input: image
          flavor:
            get_input: flavor
          # userdata:
          #   get_attribute:
          #     - cloudify_host_cloud_config
          #     - cloud_config

node_templates:
  http_server:
    type: instance
    properties:
      openstack_config: *openstack_config

    #   resource_config:
    #     groups:
    #       - wheel
    #     users:
    #       - name: { get_input: agent_user }
    #         primary-group: wheel
    #         shell: /bin/bash
    #         sudo: ['ALL=(ALL) NOPASSWD:ALL']
    #         ssh-authorized-keys:
    #           - { get_secret: agent_key_public }
    #     runcmd:
    #       - sudo service ssh stop
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: ssh_access

  ssh_access:
    type: cloudify.openstack.nodes.KeyPair
    properties:
      openstack_config: *openstack_config
      resource_id: { get_input: ssh_keyset_name }
      #use_external_resource: true
      private_key_path: { get_input: ssh_pub_key }